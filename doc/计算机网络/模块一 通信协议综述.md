# 模块一 通信协议综述

## 第1讲 | 为什么要学习网络协议？

- 程序是人与计算机沟通的渠道
  - 程序文字也是一种协议，是人类和计算机沟通的协议，只有通过这种协议，计算机才知道我们想让它做什么。
- 网络协议是程序与程序之间沟通的渠道

### 协议三要素

**编译**

![](https://static001.geekbang.org/resource/image/e8/7d/e823209e795faacdbb9b557750e7d37d.jpg)

协议三要素：

- 语法
  - 就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。
- 语义
  - 就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。
- 顺序
  - 就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。

**只有通过网络协议，才能使一大片机器互相协作、共同完成一件事。**

http协议：

```html

HTTP/1.1 200 OK
Date: Tue, 27 Mar 2018 16:50:26 GMT
Content-Type: text/html;charset=UTF-8
Content-Language: zh-CN

<!DOCTYPE html>
<html>
<head>
<base href="https://pages.kaola.com/" />
<meta charset="utf-8"/> <title>网易考拉3周年主会场</title>
```

- 语法：首部语法固定为 
  - 状态 HTTP/1.1 200 OK
  - 首部 Date Content-Type Content-Language
  - 内容 <!DOCTYPE html>
- 语义：首部状态表示此次结果
- 顺序：先请求才能响应

### 我们常用的网络协议有哪些？

- 输入一个网址会经历哪些协议
  - 应用层
    - dns协议查找ip
    - http/https打包请求
    - ![](https://static001.geekbang.org/resource/image/70/e9/70e8ad0531ada8baac174ce6862fede9.jpg)
  - 传输层
    - 确定传输方式TCP/UDP
    - ![](https://static001.geekbang.org/resource/image/64/0c/64fcf0cc5baade70769da2160637d70c.jpg)
  - 网络层
    - 添加源IP目标IP
    - ![](https://static001.geekbang.org/resource/image/19/62/191947411849da8738dfea8394780962.jpg)
  - 数据链路层
    - MAC地址 ARP协议
    - ![](https://static001.geekbang.org/resource/image/9b/79/9b0d10b384ecd0de11c8596f8890df79.jpg)
  - 发送 用到网络层协议
    - 路由协议，常用的有 OSPF 和 BGP。
  - 
- 

![](https://static001.geekbang.org/resource/image/a3/9e/a35e16acd0912ae3e79567ca0358df9e.jpg)

### 小结

- 通过网络协议来进行程序间通信/各个组件相互合作
- 协议三要素:语法、语义、顺序
- 常用网络协议：可以分层了解

![](https://static001.geekbang.org/resource/image/59/54/5985d6d430e1b1d3f165bf0f916ed954.jpg)

### 为什么用MAC不用IP

1. mac地址是唯一的，为什么可以修改?想想身份证，身份证号是唯一的，不能改变的，但是可以造价。mac地址全球唯一，它是固化在网卡里的。网卡毕竟是个硬件，需要软件支持，既操作系统识别。重点来了，操作系统识别出来的mac地址是可以更改的，它只不过是一个字符串。我们常说的修改mac指的是修改电脑中记录的既注册表中的记录。
2. 有了mac地址为什么还要有ip地址。举个例子，身份证号是你的唯一标识，不会重复，一落户就有（网卡一出厂就有mac）。现在我要和你通信（写信给你），地址用你的姓名+身份证，信能送到你手上吗?明显不能！身份证号前六位能定位你出生的县。mac地址前几位也可以定位生产厂家。但是你出生后会离开这个县（哪怕在这个县，也不能具体找到你）。所以一般写个人信息就要有出生地和现居地址了。

## 第2讲 | 网络分层的真实含义是什么？

> 长时间从事计算机网络相关的工作，我发现，计算机网络有一个显著的特点，就是这是一个不仅需要背诵，而且特别需要将原理烂熟于胸的学科。很多问题看起来懂了，但是就怕往细里问，一问就发现你懂得没有那么透彻。
>
> 当你听到什么二层设备、三层设备、四层 LB 和七层 LB 中层的时候，是否有点一头雾水，不知道这些所谓的层，对应的各种协议具体要做什么“工作”？

### 这四个问题你真的懂了吗？

- TCP在握手时IP层和数据链路层在做什么
  - 数据传输添加头部
- IP 协议里面包含目标地址和源地址。第三层里往往还会学习路由协议。那么中转的MAC地址放在哪里
  - 分层包装
- 你一定经常听说二层设备、三层设备。二层设备处理的通常是 MAC 层的东西。那我发送一个 HTTP 的包，是在第七层工作的，那是不是不需要经过二层设备？或者即便经过了，二层设备也不处理呢？或者换一种问法，二层设备处理的包里，有没有 HTTP 层的内容呢？
  - 有的但是二层设备不处理
  - 所谓的二层设备、三层设备，都是这些设备上跑的程序不同而已。一个 HTTP 协议的包经过一个二层设备，二层设备收进去的是整个网络包。这里面 HTTP、TCP、 IP、 MAC 都有。什么叫二层设备呀，就是只把 MAC 头摘下来，看看到底是丢弃、转发，还是自己留着。那什么叫三层设备呢？就是把 MAC 头摘下来之后，再把 IP 头摘下来，看看到底是丢弃、转发，还是自己留着。
  - 二层设备只专注于处理二层协议其余内容交给其他层设备
- 从你的电脑，通过 SSH 登录到公有云主机里面，都需要经历哪些过程？或者说你打开一个电商网站，都需要经历哪些过程？

### 网络为什么要分层

- 单一职责原则，分治思路，复杂问题拆分
- 当然网络包的格式很复杂，这个程序也很复杂。复杂的程序都要分层，这是程序设计的要求。比如，复杂的电商还会分数据库层、缓存层、Compose 层、Controller 层和接入层，每一层专注做本层的事情。

### 程序是如何工作的

![](https://static001.geekbang.org/resource/image/5c/76/5c00f6e610f533d17fb4ad7decacc776.jpg)

- 应用层构建http协议所需东西
- 交给传输层封装函数加上TCP头，传输方式及其他具体数据
- 交给IP层函数加上IP头部，IP地址
- 交给数据链路层函数加上MAC地址
- 万事俱备，只要 Buffer 里面的内容完整，就可以从网口发出去了，你作为一个程序的任务就算告一段落了。

### 揭秘层与层之间的关系

**所有不能表示出层层封装含义的比喻，都是不恰当的。**

> 总经理握手，不需要员工在吧，总经理之间谈什么，不需要员工参与吧，但是网络世界不是这样的。正确的应该是，总经理之间沟通的时候，经理将总经理放在自己兜里，然后组长把经理放自己兜里，员工把组长放自己兜里，像套娃娃一样。那员工直接沟通，不带上总经理，就不恰当了。

- 底层的包封装了上层的协议

这里要记住一点：**只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。**

对 TCP 协议来说，三次握手也好，重试也好，只要想发出去包，就要有 IP 层和 MAC 层，不然是发不出去的。

所以如果一个 HTTP 协议的包跑在网络上，它一定是完整的。无论这个包经过哪些设备，它都是完整的。

所谓的二层设备、三层设备，都是这些设备上跑的程序不同而已。一个 HTTP 协议的包经过一个二层设备，二层设备收进去的是整个网络包。这里面 HTTP、TCP、 IP、 MAC 都有。什么叫二层设备呀，就是只把 MAC 头摘下来，看看到底是丢弃、转发，还是自己留着。那什么叫三层设备呢？就是把 MAC 头摘下来之后，再把 IP 头摘下来，看看到底是丢弃、转发，还是自己留着。

### 小结

- 网络分层解决复杂问题
- 程序通过协议封装和解封 互相通信沟通合作
- 下层包中肯定包含上层已封好的数据



总结一下今天的内容，理解网络协议的工作模式，有两个小窍门：

- 始终想象自己是一个处理网络包的程序：如何拿到网络包，如何根据规则进行处理，如何发出去；
  - 模拟处理
- 始终牢记一个原则：只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。
  - 网络上运输的数据包肯定是从下往上的结构

### 要想学习网络协议，IP 这个概念是最最基本的，那你知道如何查看 IP 地址吗