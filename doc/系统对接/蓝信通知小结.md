# 蓝信通知小结

## 需求

使用蓝信给特定用户发送通知

对应使用场景：

**消息推送**，该类通过蓝信开放平台接口，向目标用户推送蓝信消息。**此类应用在蓝信客户端没有固定入口，无需使用者参与，即无需实现 OAuth 获取用户身份流程。**

## 对接流程

1. 找相关接口人了解对接流程
2. 通过OA发起权限申请工单，申请项目为蓝信对接功能需求
3. 等待审批，如审批流程出现问题找蓝信接口人一起想办法处理
4. 接口人可帮忙构建应用但需要提供应用及蓝信接口开发者信息
5. 构建完应用可获得appId、appSecret
6. 根据这两个应用应用授权信息调用蓝信相关接口，需https通信能力
7. 如后期有获取登录用户详细信息等获取蓝信内部数据/使用蓝信接入第三方登录功能则需完成OAuth2.0相关流程

### https证书绕过

https通信交互方式有三种，如果有权威机构办法的证书则于http交互一致，如无权威证书则需将私下生成的证书放到指定位置后续请求时调用，也可通过验签绕过的方式进行请求交互（比较常用），在应用内部/私下开发使用，正式第三方环境应用接入还是得保持https的CA验签功能

```java
	/**
     * 绕过验证
     *
     * @return
     * @throws NoSuchAlgorithmException
     * @throws KeyManagementException
     */
    public static SSLContext createIgnoreVerifySSL() throws NoSuchAlgorithmException, KeyManagementException {
        SSLContext sc = SSLContext.getInstance("SSLv3");
 
        // 实现一个X509TrustManager接口，用于绕过验证，不用修改里面的方法
        X509TrustManager trustManager = new X509TrustManager() {
            @Override
            public void checkClientTrusted(
                    java.security.cert.X509Certificate[] paramArrayOfX509Certificate,
                    String paramString) throws CertificateException {
            }
 
            @Override
            public void checkServerTrusted(
                    java.security.cert.X509Certificate[] paramArrayOfX509Certificate,
                    String paramString) throws CertificateException {
            }
 
            @Override
            public java.security.cert.X509Certificate[] getAcceptedIssuers() {
                return null;
            }
        };
 
        sc.init(null, new TrustManager[] { trustManager }, null);
        return sc;
    }
```



## 应用消息推送

根据[开发者文档](https://openapi.lanxin.cn/doc/#/server-api/message/create_app_message)描述，对接需提供一些参数：

1. 指定推送范围（包括特定推送人员/给部门推送），通过id表示
2. 请求需提供app_token

**query参数说明**：

| **参数**   | **必须** | **说明**              |
| ---------- | -------- | --------------------- |
| app_token  | 是       | 应用访问TOKEN         |
| user_token | 否       | 非必填字段, 人员TOKEN |

**请求数据示例：**

```json
{
    "userIdList": [ "524288-8euoAJ1avCqrpqSyyV2FVYJVB" ,"524288-8euoAJ1avCqrpqSyyV2FVYJVC" ],
    "departmentIdList":["524288-vAuMGGePYt7Oz7urrExFJxaVA"],
    "msgType": "type",
    "msgData":{
        "type" :{
        }
    },
    "//": "以下字段为选填字段，普通应用不需要填，以下字段仅适用于微应用或蓝信自研应用，普通应用不需要填",
    "entryId":"154741",
    "accountId":"524288-xxxxxxx",
    "attach":"xxxx"
}
```



### 获取app_token

[API样例](https://apigw-example.domain/v1/apptoken/create?grant_type=client_credential&appid=APPID&secret=APPSECRET)

**样例中具体域名会申请时返回**

**query参数说明**：

| **参数**   | **必须** | **说明**                          |
| ---------- | -------- | --------------------------------- |
| grant_type | 是       | 可赋值为："client_credential"     |
| appid      | 是       | 应用ID, 创建应用时取得            |
| secret     | 是       | 应用对应的Secret， 创建应用时取得 |

**返回参数字段说明：**

| **参数**  | **描述**                                                     |
| --------- | ------------------------------------------------------------ |
| appToken  | 应用访问TOKEN                                                |
| expiresIn | TOKEN 有效期（7200秒），建议应用根据过期时间缓存appToken, 单次获取，多次使用 |

### 获取staffId

[通过唯一标识获取人员ID](https://openapi.lanxin.cn/doc/#/server-api/staff/fetch_staff_id_mapping?id=通过唯一标识获取人员id)

根据组织id+员工号获取指定staffId

**query参数说明**：

| **参数**   | **必须** | **说明**                                                     |
| ---------- | -------- | ------------------------------------------------------------ |
| app_token  | 是       | 应用访问TOKEN                                                |
| user_token | 否       | 非必填字段，人员TOKEN                                        |
| org_id     | 是       | 查询人员所在的组织Id                                         |
| id_type    | 是       | 通过某个ID的内置类型查询人员staffId，目前支持以下几种查询类型（枚举）： employ_id – 人员号 mobile – 手机号 mail - 邮箱地址 |
| id_value   | 是       | id_type 对应的值：人员号，手机号, 邮箱地址                   |

**返回参数字段说明：**

| **参数** | **描述**    |
| -------- | ----------- |
| staffId  | 人员staffId |

其中org_id是app_id的前半部分



### 消息推送

[发送应用消息(应用号通道)](https://openapi.lanxin.cn/doc/#/server-api/message/create_app_message?id=发送应用消息应用号通道)

根据获取的staffId推送消息给特定的相关人员

**query参数说明**：

| **参数**   | **必须** | **说明**              |
| ---------- | -------- | --------------------- |
| app_token  | 是       | 应用访问TOKEN         |
| user_token | 否       | 非必填字段, 人员TOKEN |

**请求数据示例：**

```json
{
    "userIdList": [ "524288-8euoAJ1avCqrpqSyyV2FVYJVB" ,"524288-8euoAJ1avCqrpqSyyV2FVYJVC" ],
    "departmentIdList":["524288-vAuMGGePYt7Oz7urrExFJxaVA"],
    "msgType": "type",
    "msgData":{
        "type" :{
        }
    },
    "//": "以下字段为选填字段，普通应用不需要填，以下字段仅适用于微应用或蓝信自研应用，普通应用不需要填",
    "entryId":"154741",
    "accountId":"524288-xxxxxxx",
    "attach":"xxxx"
}
```



支持的消息体类型：[消息体类型](https://openapi.lanxin.cn/doc/#/server-api/message/message_body_type?id=消息体类型)

其中reminder是用于@某人，并非必填

```json
"reminder": {
                "all": false,
                "userIds": ["524288-abcdefg","524288-xabedsfaf",...]
            }
```

