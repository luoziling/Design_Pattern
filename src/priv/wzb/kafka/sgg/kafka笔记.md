# kafka笔记

## 简介

消息队列，异步。同步转异步，若发送失败需要回滚怎么处理

- linux的同步与异步
  - IO同步等待准备数据等待数据返回
  - 异步，数据准备以及数据拷贝都交给操作系统，数据准备好了回调
- 作用
  - 解耦
    - 可恢复性，基于解耦，数据在消息队列中存储加了保障防止数据丢失
  - 缓解压力，削峰
    - 缓冲，解决生产速度快于消费速度
  - 
- 消息队列的模式
  - 点对点
    - 一对一 消息不可复用
  - 发布/订阅
    - 一个队列，多人订阅，kafka/redis stream
    - 两种模式
      - 消费者主动拉取
        - stream就是主动拉取通过xGroupRead kafka也是，消费者消费速度可自己决定
        - 缺陷：需要轮询，今天出现了死循环轮询导致空转导致CPU资源浪费
      - 公众号，被动推送
        - 威哥说的回调就是这种
        - 解决长轮询
        - rocketmq
    - 

### 架构

- 与stream类似支持集群，支持数据分发，topic类似不同队列streamName,但是kafka拥有备份leader/follower follower只负责备份不负责读写
- 与stream一样拥有消费者组的概念
- 同一个分区数据只能被同一个组内的同一个人消费
  - 防止重复消费，redis由于单线程解决线程安全问题
  - kafka通过单partition单消费者解决线程安全问题
- 消费者组
  - 提高消费能力
  - 提供重复消费
  - 消费者数必须<=分区数
- zookeeper管理kafka集群
  - 借助zk的集群实现kafka的集群
  - 监控信息由zk记录而stream自身内部记录
  - 消费者自身内部维护消费信息，若挂了则从zk获取后继续消费
  - 集群信息+消费信息 0.9之前存在zk 0.9之后存在kafka就跟stream一样
    - 改动原因消费者跟kafka leader连接，吞吐量非常大，若每次都要维护zk则带来庞大的额外资源消耗，不如交给kafka自身管理
    - zk是润滑剂，不应承担过重业务，单一职责原则
  - 
- 